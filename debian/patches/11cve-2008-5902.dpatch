#! /bin/sh /usr/share/dpatch/dpatch-run
## 11cve-2008-5902.dpatch by  <bernat@neo.luffy.cx>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Fix CVE-2008-5902
## DP: Buffer overflow in the xrdp_bitmap_invalidate function in
## DP: xrdp/xrdp_bitmap.c in xrdp 0.4.1 and earlier allows remote attackers
## DP: to execute arbitrary code via a crafted request.

@DPATCH@

--- xrdp/xrdp/xrdp_bitmap.c	2007/05/06 06:50:45	1.38
+++ xrdp/xrdp/xrdp_bitmap.c	2009/01/23 07:04:21	1.38.2.2
@@ -1211,6 +1211,7 @@
   int shift;
   int ext;
   int scan_code;
+  int len;
   struct xrdp_bitmap* b;
   struct xrdp_bitmap* focus_out_control;
 
@@ -1396,7 +1397,8 @@
                                     self->wm->num_lock,
                                     self->wm->scroll_lock,
                                     self->wm->session->client_info->keylayout);
-        if ((unsigned char)c >= 32)
+        len = g_strlen(self->caption1);
+        if (((unsigned char)c >= 32) && (len < 127))
         {
           add_char_at(self->caption1, c, self->edit_pos);
           self->edit_pos++;
