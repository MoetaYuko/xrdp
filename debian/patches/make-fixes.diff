# DP: recurse into xorgxrdp/ as well (make into proper configure option?)
# DP: also, actually install keymaps shipped (should be upstreamed)

--- a/Makefile.am
+++ b/Makefile.am
@@ -27,4 +27,5 @@ SUBDIRS = \
   instfiles \
   genkeymap \
   xrdpapi \
+  xorgxrdp \
   $(XRDPVRDIR)
--- a/common/Makefile.am
+++ b/common/Makefile.am
@@ -40,7 +40,12 @@ libcommon_la_SOURCES = \
   thread_calls.c \
   trans.c
 
+if NEED_LIBDL
+EXTRA_LIBDL = -ldl
+endif
+
 libcommon_la_LIBADD = \
+  $(EXTRA_LIBDL) \
   -lcrypto \
   -lssl \
   -lpthread
--- a/configure.ac
+++ b/configure.ac
@@ -210,6 +210,14 @@ AC_CHECK_HEADER([X11/extensions/Xrandr.h
   [AC_MSG_ERROR([please install libxrandr-dev or libXrandr-devel])],
   [#include <X11/Xlib.h>])
 
+# checking if we need libdl
+save_LIBS=$LIBS
+AC_SEARCH_LIBS([dlopen], [dl dld], [], [
+  AC_MSG_ERROR([unable to find the dlopen() function])
+])
+AM_CONDITIONAL(NEED_LIBDL, [test x"$LIBS" != x"$save_LIBS"])
+LIBS=$save_LIBS
+
 libdir="${libdir}/xrdp";
 if test "x${prefix}" = "xNONE" ; then
 sysconfdir="/etc";
--- a/xrdpapi/Makefile.am
+++ b/xrdpapi/Makefile.am
@@ -9,6 +9,7 @@ AM_CFLAGS = \
   $(EXTRA_DEFINES)
 
 INCLUDES = \
+  -I$(top_srcdir)/common \
   $(EXTRA_INCLUDES)
 
 lib_LTLIBRARIES = \
@@ -21,4 +22,5 @@ libxrdpapi_la_LDFLAGS = \
   $(EXTRA_FLAGS)
 
 libxrdpapi_la_LIBADD = \
+  $(top_builddir)/common/libcommon.la \
   $(EXTRA_LIBS)
